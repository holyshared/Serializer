//Licence: The MIT Licence
//Author: Noritaka Horio<holy.shared.design@gmail.com>
//Copyright 2011 Noritaka Horio all rights reserved.
(function(){var b=this.Serializer=function(){};var a=b.Container={types:{},get:function(e){if(!this.has(e)){return false}return this.types[e]},register:function(e,f){if(this.has(e)){throw new Error("The specified data type has already been registered.")}this.types[e]=f},unregister:function(e){if(!this.has(e)){throw new Error("The specified data type is not registered.")}delete this.types[e]},has:function(e){if(!this.types[e]){return}return true},find:function(g){var f;for(var e in this.types){f=this.types[e];if(f.match(g)){return f}}return false},serialize:function(f){var e=typeOf(f);var g=this.get(e);return g.serialize(f)},deserialize:function(g){var f,e;if(!(f=this.find(g))){throw new Error("It is not possible to convert it into the object.")}e=f.compile(g);return f.deserialize(e)}};b.implement({serialize:function(e){return a.serialize(e)},deserialize:function(e){return a.deserialize(e)}});Object.append(b,{_variableStart:"{",_variableEnd:"}",setVariableRule:function(e){if(!e.start||!e.end){throw new TypeError("Option specification is not carried out.")}this._variableStart=this._validateRule(e.start);this._variableEnd=this._validateRule(e.end);return this},getVariableRule:function(){var e={start:this._variableStart,end:this._variableEnd};return e},_validateRule:function(e){if(!Type.isString(e)){throw new TypeError("It is invalid variable rule")}return e},register:function(g,f){var e=typeOf(g.prototype);var f=new b.Converter(f);a.register(e,f);return b},unregister:function(f){var e=typeOf(f.prototype);a.unregister(e);return b}});var c=b.Variable={parsePaturn:function(e,g){var h={};Object.each(g,function(j,i){h[i]="("+j+")"});var f=c.variablePaturn();e=e.replace(f,function(i,j){if(i.charAt(0)=="\\"){return i.slice(1).escapeRegExp()}else{return h[j]}});return new RegExp(e,"i")},variablePaturn:function(){var h=b.getVariableRule();var i=h.start.escapeRegExp(),e=h.end.escapeRegExp();var f="\\\\?"+i+"([^"+i+e+"]+)"+e;var g=new RegExp(f,"g");return g}};var d=b.Converter=function(e){Object.append(this,e||{})};d.implement({_compiledParser:null,_compiledVariable:null,_compileParser:function(){if(this._compiledParser){return this._compiledParser}this._compiledParser=c.parsePaturn(this.paturn,this.params);return this._compiledParser},_compileVariable:function(){if(this._compiledVariable){return this._compiledVariable}this._compiledVariable=c.variablePaturn();return this._compiledVariable},_parse:function(f){var h,e;var g=this._compileParser();h=f.match(g);if(h==false){return}h.shift();return h},assemble:function(g){var f=this._compileVariable();var e=this.paturn.replace(f,function(h,i){return g[i]});e=e.replace(/\\?/g,"");return e},match:function(e){var f=this._compileParser();if(!f.test(e)){return}return true},compile:function(f){var e=this._parse(f);try{hash=e.associate(Object.keys(this.params))}catch(g){throw new Error("It failed in the compilation of the restoration pattern of deserialize.")}return hash}})}());